{% extends "mobile_base.html" %}

{% block title %}Dashboard - PharmaBot{% endblock %}

{% block content %}
<header class="app-header">
    <div class="header-actions">
        <div>
            <h1>Welcome, {{ current_user.username }}!</h1>
            <p>Your medication dashboard</p>
        </div>
    </div>
</header>

<div class="app-content">
    <!-- Stats Section -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-pills"></i></div>
            <div class="stat-value">{{ total_medicines }}</div>
            <div class="stat-label">Active Medicines</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-value">{{ taken_today }}/{{ total_today }}</div>
            <div class="stat-label">Taken Today</div>
        </div>
    </div>

    <!-- Medicine Statistics -->
    {% if medicine_stats %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title"><i class="fas fa-chart-line"></i> Medicine Statistics</h2>
            <span class="badge badge-info">Last 7 days</span>
        </div>
        
        <div style="padding: 0;">
            {% for stat in medicine_stats %}
            <div class="medicine-stat-item" style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                            <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">{{ stat.medicine.name }}</h3>
                            {% if stat.compartment_number > 0 %}
                            <span class="badge" style="background: #6366f1; font-size: 0.75rem;">
                                <i class="fas fa-box"></i> Slot {{ stat.compartment_number }}
                            </span>
                            {% endif %}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">{{ stat.medicine.dosage }}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem; font-weight: 700; 
                            {% if stat.adherence_rate >= 80 %}color: var(--secondary-color);
                            {% elif stat.adherence_rate >= 60 %}color: var(--warning-color);
                            {% else %}color: var(--danger-color);
                            {% endif %}">
                            {{ stat.adherence_rate }}%
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Adherence</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div style="background: var(--bg-secondary); padding: 0.5rem; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--secondary-color);">{{ stat.taken_doses }}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Taken</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 0.5rem; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--danger-color);">{{ stat.skipped_doses }}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Skipped</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 0.5rem; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-secondary);">{{ stat.total_schedules }}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Total</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div style="margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.75rem; color: var(--text-secondary);">
                        <span>Weekly Progress</span>
                        <span>{{ stat.taken_doses }}/{{ stat.total_schedules }} doses</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; 
                            {% if stat.adherence_rate >= 80 %}background: var(--secondary-color);
                            {% elif stat.adherence_rate >= 60 %}background: var(--warning-color);
                            {% else %}background: var(--danger-color);
                            {% endif %}
                            width: {{ stat.adherence_rate }}%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                
                <!-- Today's Status -->
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: var(--bg-secondary); border-radius: var(--radius-sm);">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-calendar-day" style="color: var(--primary-color);"></i>
                        <span style="font-size: 0.875rem; font-weight: 500;">Today:</span>
                    </div>
                    <div style="font-weight: 600;">
                        {% if stat.today_total > 0 %}
                            <span style="{% if stat.today_taken == stat.today_total %}color: var(--secondary-color);{% endif %}">
                                {{ stat.today_taken }}/{{ stat.today_total }} doses
                            </span>
                            {% if stat.today_taken == stat.today_total %}
                                <i class="fas fa-check-circle" style="color: var(--secondary-color); margin-left: 0.25rem;"></i>
                            {% endif %}
                        {% else %}
                            <span style="color: var(--text-secondary);">No doses scheduled</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if stat.medicine.instructions %}
                <div style="margin-top: 0.75rem; padding: 0.5rem; background: #fef3c7; border-left: 3px solid var(--warning-color); border-radius: 4px;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: #92400e; margin-bottom: 0.25rem;">
                        <i class="fas fa-info-circle"></i> Instructions
                    </div>
                    <div style="font-size: 0.875rem; color: #78350f;">{{ stat.medicine.instructions }}</div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Today's Schedule -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Today's Schedule</h2>
            <span class="badge badge-info">{{ today_schedules|length }} doses</span>
        </div>
        
        {% if today_schedules %}
        <div class="schedule-list">
            {% for schedule in today_schedules %}
            <div class="schedule-item {% if schedule.taken %}taken{% elif schedule.skipped %}skipped{% endif %}">
                <div class="schedule-time">
                    <div class="schedule-hour">{{ schedule.scheduled_time.strftime('%I:%M') }}</div>
                    <div class="schedule-period">{{ schedule.scheduled_time.strftime('%p') }}</div>
                </div>
                <div class="schedule-info">
                    <div class="schedule-medicine">{{ schedule.medicine.name }}</div>
                    <div class="schedule-dosage">{{ schedule.medicine.dosage }}</div>
                    {% if schedule.medicine.instructions %}
                    <div class="schedule-dosage">{{ schedule.medicine.instructions }}</div>
                    {% endif %}
                </div>
                {% if not schedule.taken and not schedule.skipped %}
                <div class="schedule-actions">
                    <button class="btn btn-success btn-sm btn-icon" onclick="markTaken({{ schedule.id }})"><i class="fas fa-check"></i></button>
                    <button class="btn btn-secondary btn-sm btn-icon" onclick="markSkipped({{ schedule.id }})"><i class="fas fa-times"></i></button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-calendar-check"></i></div>
            <p class="empty-text">No medications scheduled for today</p>
        </div>
        {% endif %}
    </div>

    <!-- Recent Prescriptions -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Recent Prescriptions</h2>
            <a href="{{ url_for('main.prescriptions') }}" class="btn btn-sm btn-secondary">View All</a>
        </div>
        
        {% if prescriptions %}
        {% for prescription in prescriptions %}
        <div class="device-card">
            <div class="device-icon"><i class="fas fa-file-medical"></i></div>
            <div class="device-info">
                <div class="device-name">
                    {% if prescription.doctor_name %}
                    Dr. {{ prescription.doctor_name }}
                    {% else %}
                    Prescription #{{ prescription.id }}
                    {% endif %}
                </div>
                <div class="device-status">
                    {{ prescription.created_at.strftime('%b %d, %Y') }} • {{ prescription.medicines|length }} medicines
                </div>
            </div>
            <a href="{{ url_for('main.prescription_detail', prescription_id=prescription.id) }}" class="btn btn-sm btn-primary">View</a>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-file-prescription"></i></div>
            <p class="empty-text">No prescriptions yet</p>
        </div>
        {% endif %}
    </div>

    <!-- Arduino Setup -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Arduino Dispenser</h2>
        </div>
        <div style="padding: 1rem;">
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Set up your automatic medication dispenser with Arduino/ESP32
            </p>
            <a href="{{ url_for('main.arduino_setup') }}" class="btn btn-primary btn-block">
                <i class="fas fa-microchip"></i> Setup Arduino Device
            </a>
        </div>
    </div>

    <!-- Connected Devices -->
    {% if devices %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Connected Devices</h2>
        </div>
        {% for device in devices %}
        <div class="device-card">
            <div class="device-icon"><i class="fas fa-microchip"></i></div>
            <div class="device-info">
                <div class="device-name">{{ device.device_name }}</div>
                <div class="device-status">
                    <span class="status-indicator {% if device.is_online %}status-online{% else %}status-offline{% endif %}"></span>
                    {% if device.is_online %}Online{% else %}Offline{% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Floating Action Button -->
<button class="fab" onclick="window.location.href='{{ url_for('main.prescriptions') }}?upload=1'">
    ➕
</button>
{% endblock %}

{% block extra_js %}
<script>
function markTaken(scheduleId) {
    fetch(`/api/schedule/${scheduleId}/mark-taken`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function markSkipped(scheduleId) {
    fetch(`/api/schedule/${scheduleId}/mark-skipped`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}
</script>
{% endblock %}
