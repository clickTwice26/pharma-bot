{% extends "mobile_base.html" %}

{% block title %}Dashboard - PharmaBot{% endblock %}

{% block content %}
<header class="app-header">
    <div class="header-actions">
        <div>
            <h1>Welcome, {{ current_user.username }}!</h1>
            <p>Your medication dashboard</p>
        </div>
    </div>
</header>

<div class="app-content">
    <!-- Stats Section -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-pills"></i></div>
            <div class="stat-value">{{ total_medicines }}</div>
            <div class="stat-label">Active Medicines</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-value">{{ taken_today }}/{{ total_today }}</div>
            <div class="stat-label">Taken Today</div>
        </div>
    </div>

    <!-- Today's Schedule -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Today's Schedule</h2>
            <span class="badge badge-info">{{ today_schedules|length }} doses</span>
        </div>
        
        {% if today_schedules %}
        <div class="schedule-list">
            {% for schedule in today_schedules %}
            <div class="schedule-item {% if schedule.taken %}taken{% elif schedule.skipped %}skipped{% endif %}">
                <div class="schedule-time">
                    <div class="schedule-hour">{{ schedule.scheduled_time.strftime('%I:%M') }}</div>
                    <div class="schedule-period">{{ schedule.scheduled_time.strftime('%p') }}</div>
                </div>
                <div class="schedule-info">
                    <div class="schedule-medicine">{{ schedule.medicine.name }}</div>
                    <div class="schedule-dosage">{{ schedule.medicine.dosage }}</div>
                    {% if schedule.medicine.instructions %}
                    <div class="schedule-dosage">{{ schedule.medicine.instructions }}</div>
                    {% endif %}
                </div>
                {% if not schedule.taken and not schedule.skipped %}
                <div class="schedule-actions">
                    <button class="btn btn-success btn-sm btn-icon" onclick="markTaken({{ schedule.id }})"><i class="fas fa-check"></i></button>
                    <button class="btn btn-secondary btn-sm btn-icon" onclick="markSkipped({{ schedule.id }})"><i class="fas fa-times"></i></button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-calendar-check"></i></div>
            <p class="empty-text">No medications scheduled for today</p>
        </div>
        {% endif %}
    </div>

    <!-- Recent Prescriptions -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Recent Prescriptions</h2>
            <a href="{{ url_for('main.prescriptions') }}" class="btn btn-sm btn-secondary">View All</a>
        </div>
        
        {% if prescriptions %}
        {% for prescription in prescriptions %}
        <div class="device-card">
            <div class="device-icon"><i class="fas fa-file-medical"></i></div>
            <div class="device-info">
                <div class="device-name">
                    {% if prescription.doctor_name %}
                    Dr. {{ prescription.doctor_name }}
                    {% else %}
                    Prescription #{{ prescription.id }}
                    {% endif %}
                </div>
                <div class="device-status">
                    {{ prescription.created_at.strftime('%b %d, %Y') }} • {{ prescription.medicines|length }} medicines
                </div>
            </div>
            <a href="{{ url_for('main.prescription_detail', prescription_id=prescription.id) }}" class="btn btn-sm btn-primary">View</a>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-file-prescription"></i></div>
            <p class="empty-text">No prescriptions yet</p>
        </div>
        {% endif %}
    </div>

    <!-- Arduino Setup -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Arduino Dispenser</h2>
        </div>
        <div style="padding: 1rem;">
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Set up your automatic medication dispenser with Arduino/ESP32
            </p>
            <a href="{{ url_for('main.arduino_setup') }}" class="btn btn-primary btn-block">
                <i class="fas fa-microchip"></i> Setup Arduino Device
            </a>
        </div>
    </div>

    <!-- Connected Devices -->
    {% if devices %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Connected Devices</h2>
        </div>
        {% for device in devices %}
        <div class="device-card">
            <div class="device-icon"><i class="fas fa-microchip"></i></div>
            <div class="device-info">
                <div class="device-name">{{ device.device_name }}</div>
                <div class="device-status">
                    <span class="status-indicator {% if device.is_online %}status-online{% else %}status-offline{% endif %}"></span>
                    {% if device.is_online %}Online{% else %}Offline{% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Floating Action Button -->
<button class="fab" onclick="window.location.href='{{ url_for('main.prescriptions') }}?upload=1'">
    ➕
</button>
{% endblock %}

{% block extra_js %}
<script>
function markTaken(scheduleId) {
    fetch(`/api/schedule/${scheduleId}/mark-taken`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function markSkipped(scheduleId) {
    fetch(`/api/schedule/${scheduleId}/mark-skipped`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}
</script>
{% endblock %}
